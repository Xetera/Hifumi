---
- name: Ensure docker is installed
  pip:
    name:
      - docker

- name: Ensure hifuminet is created
  docker_network:
    name: hifuminet

- name: Creating datadog-agent
  docker_container:
    name: datadog-client
    image: datadog/agent:latest
    log_driver: fluentd
    env:
      DD_API_KEY: "{{ lookup('env', 'DATADOG_API_KEY') }}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
    networks:
      - name: hifuminet

- name: Creating database
  docker_container:
    name: mongo
    log_driver: fluentd
    image: mongo
    volumes:
      - ./data/db:/data/db
    networks:
      - name: hifuminet

- name: Creating database administration
  docker_container:
    name: mongo-client
    image: mongoclient/mongoclient
    log_driver: fluentd
    env:
      MONGO_URL: mongodb://mongo/hifumi
      MONGOCLIENT_AUTH: "true"
      MONGOCLIENT_USERNAME: hifumi
      MONGOCLIENT_PASSWORD: test
    ports:
      - 3001:3000
    networks:
      - name: hifuminet
        
- name: Updating hifumi's image
  docker_container:
    name: hifumi
    image: moedevs/hifumi
    log_driver: fluentd
    pull: yes
    env:
      TOKEN: "{{  lookup('env', 'TOKEN')  }}"
      PREFIX: $
      OWNERS: "{{ lookup('env', 'OWNERS') }}"
      DATADOG_API_KEY: "{{  lookup('env', 'DATADOG_API_KEY')  }}"
      DATABASE_URL: mongodb://mongo/hifumi
      NODE_ENV: production
    networks:
      - name: hifuminet
